# COS AccessDenied 错误排查指南

## 🚨 错误现象

```xml
<Error>
<Code>AccessDenied</Code>
<Message>Access Denied.</Message>
<Resource>/cover.png</Resource>
</Error>
```

## 🔍 问题分析

`AccessDenied` 表示权限被拒绝，即使设置了"公有读私有写"仍可能有以下问题：

## 🛠️ 详细解决步骤

### 1. 检查存储桶 ACL 权限设置

#### 步骤 A：进入存储桶权限管理

1. 登录腾讯云控制台
2. 进入**对象存储 COS** → **存储桶列表**
3. 点击存储桶名称：`huishangwuyu-1320493202`
4. 进入**权限管理** → **存储桶 ACL**

#### 步骤 B：确认权限设置

确保设置如下：

- ✅ **所有者权限**：读取、写入
- ✅ **公共读取**：已启用
- ✅ **公共写入**：已禁用

如果显示不是这样，请修改为：

```
所有者: READ, WRITE
所有用户: READ
```

### 2. 检查单个文件的权限

#### 步骤 A：检查文件 ACL

1. 进入**文件列表**
2. 找到 `cover.png` 文件
3. 点击文件右侧的**详情**
4. 进入**权限设置**

#### 步骤 B：设置文件权限

确保文件权限为：

- ✅ **所有者**：读取、写入
- ✅ **公共读取**：已启用

### 3. 检查存储桶策略（Bucket Policy）

#### 步骤 A：查看存储桶策略

1. 在存储桶管理页面
2. 进入**权限管理** → **存储桶策略**
3. 查看是否有拒绝访问的策略

#### 步骤 B：添加允许策略（如果需要）

如果没有策略或策略有问题，可以添加以下策略：

```json
{
  "Version": "2.0",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "qcs": ["qcs::cam::anyone:anyone"]
      },
      "Action": ["cos:GetObject"],
      "Resource": [
        "qcs::cos:ap-nanjing:uid/1320493202:huishangwuyu-1320493202/*"
      ]
    }
  ]
}
```

### 4. 检查子账号权限（如果使用子账号）

如果你使用的是子账号：

1. 进入**访问管理 CAM**
2. 确保子账号有 COS 的读取权限

### 5. 检查网络限制

#### 步骤 A：查看 IP 白名单

1. 在存储桶管理页面
2. 进入**安全管理** → **IP 黑白名单**
3. 确保没有 IP 限制或添加了正确的白名单

#### 步骤 B：检查 Referer 防盗链

1. 进入**安全管理** → **防盗链设置**
2. 建议暂时选择**关闭防盗链**
3. 或者添加以下白名单：
   - `*.weixin.qq.com`
   - `*.qq.com`
   - `servicewechat.com`

### 6. 重新上传文件（推荐方案）

有时最简单的解决方法是重新上传：

#### 步骤 A：删除现有文件

1. 在文件列表中选中 `cover.png`
2. 点击**删除**

#### 步骤 B：重新上传

1. 点击**上传文件**
2. 选择 `cover.png` 文件
3. 在上传设置中：
   - ✅ 勾选**公有读私有写**
   - ✅ 确认**存储类型**为标准存储

### 7. 使用命令行测试

可以使用 curl 命令测试：

```bash
curl -I "https://huishangwuyu-1320493202.cos.ap-nanjing.myqcloud.com/cover.png"
```

如果返回 `HTTP/1.1 200 OK` 说明权限正确。

## 🔧 快速修复脚本

如果需要批量设置文件权限，可以在 COS 控制台的文件列表中：

1. 全选需要设置的文件
2. 点击**批量操作** → **修改权限**
3. 设置为**公有读私有写**

## ⚠️ 注意事项

1. **权限设置需要时间生效**：修改后等待 1-2 分钟
2. **清除浏览器缓存**：确保测试的是最新状态
3. **检查账户余额**：确保 COS 服务没有因欠费暂停

## 🧪 验证步骤

完成设置后，按以下顺序验证：

1. **浏览器测试**：直接访问 COS 链接
2. **命令行测试**：使用 curl 检查 HTTP 状态
3. **小程序测试**：在开发工具中测试

如果浏览器能正常访问，说明 COS 权限配置正确，问题可能在小程序域名配置上。
